## 要件

機能要件

- 必須
  - 書籍検索 + 表紙取得（楽天ブックスAPI + Google Books API / Amazon PA API）
  - 9冊リスト作成・編集（ログイン必須）
  - 表紙クリック → モーダル表示（感想・紹介文 + Amazon・楽天アフィリエイトリンク 両方）
  - ネタバレON/OFF（shelf_books.is_spoiler）
  - SNS共有
    - Twitter
    - リンクコピー
  - OGP（動的OG画像生成 by @vercel/og）
  - Analytics
  - 閲覧はログイン不要（URLシェアで誰でも閲覧可能）
  - 複数リスト管理（ジャンル別・年ベスト別など）
- スコープ外（将来検討）
  - スクリーンショット共有（CORS・Canvas汚染問題があるため除外）
  - レイアウト崩れ対策（アスペクト比統一は後回し）
- v2
  - いいね/ブックマーク
  - SNS共有
    - Instagram
    - その他
- v3
  - 人気本ランキング（登録数・モーダル開封数・アフィリクリック数を合算して「気に入られている本」を集計・表示）
  - ジャンル別・期間別のランキングページ

ビジネス要件

- アフィリエイト（必須）
  - Amazon: ISBNベースのリンク（`amazon.co.jp/s?k=ISBN&tag=xxxxx-22`）
  - 楽天ブックス: 楽天アフィリエイトリンク
  - 両方掲載しユーザーが選択できる設計（どちらで購入されても収益化）
  - アフィリエイトURL・感想はDBに保存（書籍登録時に一緒に保存）
  - アフィリエイトURLは運営者（自分）固定のURLを使用。同一ISBNを別ユーザーが登録してもupsertで上書きされる設計
  - Amazon PA API は最初から実装（売上実績は確保できる想定）
- Web広告: Google AdSense（将来実装予定）
- Analytics計測

## 認証設計

- 閲覧: ログイン不要
- 作成・編集: ログイン必須
- フロー: 「作成」ボタン押下 → ログイン画面へ誘導 → ログイン後に作成画面へ
- Clerk ↔ Turso 同期: **Webhook方式**
  - Clerk の `user.created` イベントを Vercel API Route で受け取り Turso の `users` テーブルに insert
  - `users.id` は Clerk の `userId`（`user_xxxxx`）をそのまま使用

## URL設計

- shelf の閲覧URL: `/shelf/{UUID}`（例: `/shelf/550e8400-e29b-41d4-a716-xxxxxxxxxxxx`）
- 1ユーザーが複数 shelf を持てる設計
- shelf 一覧: `/users/{clerkUserId}` 等（検討中）

## 実装

- フロント: React + Tailwind + React Router v7
- デプロイ: Vercel
- OGP画像生成: @vercel/og（Vercel Edge Function）
- DB: Turso（libSQL / D1互換のSQLite）
- 認証: Clerk（React Router v7 公式adapter使用）
- バックエンド: Vercel API Routes（Cloudflare Workers は使用しない）

## 書影API

### 取得アーキテクチャ

```
検索クエリ
  ↓
楽天ブックス + Google Books を並列fetch
  ↓
書影が見つかった時点でSkeletonからプログレッシブ表示
  ↓
Amazon PA API は上2つで取れなかった場合のフォールバック
```

- 書影の優先順位: **楽天ブックス → Google Books → Amazon PA API**
- Amazon PA APIはアフィリリンク生成がメインの用途、書影はフォールバック扱いでAPIレートを温存
- 並列fetchにより待ち時間を最小化

### 表示UX

- Skeleton UI を採用（書影枠をグレーで仮表示 → 取得完了次第差し替え）
- 取得できた書影から順次プログレッシブ表示

### Amazon PA API

- 用途: 書影取得のフォールバック + Amazonアフィリエイトリンク生成
- レート制限: **1リクエスト/秒**（初期固定）/ 過去30日の売上実績に応じて最大10req/秒程度までスケール
- キャッシュ: 短期キャッシュのみ可、DB永続保存は不可
- 注意: 並列リクエストは避けること

### Google Books API

- 用途: 書籍検索・表紙取得のサブ（洋書・補完用）
- 無料枠: 1,000リクエスト/日
- キャッシュ: 短期キャッシュのみ可、DBへの永続保存は不可
- 注意: 同一ISBNで複数エディションの表紙が返る可能性あり → 表示する表紙を選択できる設計が必要

### 楽天ブックスAPI

- 用途: 書籍検索・表紙取得のメイン（日本語書籍・漫画・ラノベに強い）
- 無料枠: 50,000リクエスト/日、1リクエスト/秒
- キャッシュ: **禁止**（利用規約第5条）
- 注意: 同一書籍でも複数の表紙画像パターンが取得される可能性あり → 表示する表紙を選択できる設計が必要
- 楽天アフィリエイトリンクと組み合わせて使用

## DB スキーマ

### users

| カラム       | 型          | 備考     |
| ------------ | ----------- | -------- |
| id           | TEXT (UUID) | PK       |
| display_name | TEXT        |          |
| avatar_url   | TEXT        | nullable |
| created_at   | DATETIME    |          |

### shelves（9冊まとめ）

| カラム      | 型          | 備考                  |
| ----------- | ----------- | --------------------- |
| id          | TEXT (UUID) | PK                    |
| user_id     | TEXT        | FK → users.id         |
| name        | TEXT        | リスト名              |
| view_count  | INTEGER     | DEFAULT 0（閲覧数）   |
| likes_count | INTEGER     | DEFAULT 0（将来実装） |
| created_at  | DATETIME    |                       |
| updated_at  | DATETIME    |                       |

> 公開/非公開フラグなし。不要になった場合は削除のみ。

### books（書籍マスタ）

| カラム                | 型   | 備考     |
| --------------------- | ---- | -------- |
| isbn                  | TEXT | PK       |
| amazon_affiliate_url  | TEXT | nullable |
| rakuten_affiliate_url | TEXT | nullable |

> タイトル・著者・書影URLはAPI規約上保存不可。表示時に都度fetchする。

### shelf_books（shelf ↔ book 中間）

| カラム     | 型          | 備考                    |
| ---------- | ----------- | ----------------------- |
| id         | TEXT (UUID) | PK                      |
| shelf_id   | TEXT        | FK → shelves.id         |
| isbn       | TEXT        | FK → books.isbn         |
| position   | INTEGER     | 1〜9（並び順）          |
| review     | TEXT        | 感想・紹介文 nullable   |
| is_spoiler | INTEGER     | 0/1（SQLiteのBool代替） |
| created_at | DATETIME    |                         |

### user_shelf_bookmarks（将来実装）

| カラム     | 型          | 備考            |
| ---------- | ----------- | --------------- |
| id         | TEXT (UUID) | PK              |
| user_id    | TEXT        | FK → users.id   |
| shelf_id   | TEXT        | FK → shelves.id |
| created_at | DATETIME    |                 |

### user_book_bookmarks（将来実装）

| カラム     | 型          | 備考            |
| ---------- | ----------- | --------------- |
| id         | TEXT (UUID) | PK              |
| user_id    | TEXT        | FK → users.id   |
| isbn       | TEXT        | FK → books.isbn |
| created_at | DATETIME    |                 |

### データフロー

```
本を登録するとき:
  1. books に isbn + アフィリURL を upsert
  2. shelves を作成（なければ）
  3. shelf_books に position・review・is_spoiler を insert

閲覧するとき:
  1. shelves を取得
  2. shelf_books を shelf_id で取得（position 順）
  3. isbn をキーに楽天/Google Books API から書影・タイトルを fetch
  4. books から affiliate_url を取得してモーダルに表示
```

## フロントエンド URL 設計

| URL               | 説明                            | 認証                  |
| ----------------- | ------------------------------- | --------------------- |
| `/`               | トップ / ランディング           | 不要                  |
| `/shelf/new`      | shelf 新規作成                  | **必須**              |
| `/shelf/:id`      | shelf 閲覧（SNS共有先）         | 不要                  |
| `/shelf/:id/edit` | shelf 編集                      | **必須**（ownerのみ） |
| `/me`             | 自分の shelf 一覧               | **必須**              |
| `/users/:userId`  | 他ユーザーの shelf 一覧（公開） | 不要                  |

## REST API 設計

### 書籍検索

| Method | Path                          | 説明                 | 認証 |
| ------ | ----------------------------- | -------------------- | ---- |
| `GET`  | `/api/books/search?q={query}` | 楽天+Google 並列検索 | 不要 |

### Shelves

| Method   | Path                         | 説明                                 | 認証     |
| -------- | ---------------------------- | ------------------------------------ | -------- |
| `GET`    | `/api/shelves/:id`           | shelf 取得（書籍一覧含む）           | 不要     |
| `GET`    | `/api/users/:userId/shelves` | ユーザーの shelf 一覧                | 不要     |
| `POST`   | `/api/shelves`               | shelf 新規作成                       | **必須** |
| `PATCH`  | `/api/shelves/:id`           | shelf 名変更                         | **必須** |
| `DELETE` | `/api/shelves/:id`           | shelf 削除                           | **必須** |
| `POST`   | `/api/shelves/:id/view`      | 閲覧数インクリメント（ページ表示時） | 不要     |

### Shelf の本

| Method   | Path                             | 説明                       | 認証     |
| -------- | -------------------------------- | -------------------------- | -------- |
| `POST`   | `/api/shelves/:id/books`         | 本を追加（最大9冊）        | **必須** |
| `PATCH`  | `/api/shelves/:id/books/:isbn`   | 感想・ネタバレ・順番を更新 | **必須** |
| `DELETE` | `/api/shelves/:id/books/:isbn`   | 本を削除                   | **必須** |
| `PATCH`  | `/api/shelves/:id/books/reorder` | 並び順一括更新             | **必須** |

### OGP

| Method | Path               | 説明                     |
| ------ | ------------------ | ------------------------ |
| `GET`  | `/api/og/:shelfId` | OG画像生成（@vercel/og） |

### Webhook

| Method | Path                  | 説明                                               |
| ------ | --------------------- | -------------------------------------------------- |
| `POST` | `/api/webhooks/clerk` | Clerk の `user.created` を受け取り Turso に insert |

## SNS 共有

| SNS       | 実装方法                                                      | 時期 |
| --------- | ------------------------------------------------------------- | ---- |
| Twitter   | Web Intent URL（`twitter.com/intent/tweet?url=...&text=...`） | 必須 |
| URLコピー | `navigator.clipboard.writeText()`                             | 必須 |
| Instagram | ストーリーズ共有API or 画像DL誘導                             | 将来 |

## Analytics 設計

### Turso コンソールで確認できること（SQLで直接確認）

**サービス全体**
| 確認したいこと | クエリ |
|---|---|
| 総登録ユーザー数 | `SELECT COUNT(*) FROM users` |
| 日別新規登録ユーザー数 | `SELECT DATE(created_at), COUNT(*) FROM users GROUP BY DATE(created_at)` |
| 総Shelf作成数 | `SELECT COUNT(*) FROM shelves` |
| 日別Shelf作成数 | `SELECT DATE(created_at), COUNT(*) FROM shelves GROUP BY DATE(created_at)` |
| 総登録本数 | `SELECT COUNT(*) FROM shelf_books` |
| 1Shelfあたりの平均本数 | `SELECT AVG(cnt) FROM (SELECT COUNT(*) cnt FROM shelf_books GROUP BY shelf_id)` |

**Shelf・本**
| 確認したいこと | クエリ |
|---|---|
| 閲覧数TOP10 Shelf | `SELECT id, name, view_count FROM shelves ORDER BY view_count DESC LIMIT 10` |
| 最もよく登録される本（ISBN） | `SELECT isbn, COUNT(*) cnt FROM shelf_books GROUP BY isbn ORDER BY cnt DESC LIMIT 10` |
| ネタバレONの本の割合 | `SELECT AVG(is_spoiler) FROM shelf_books` |

### Vercel Analytics で確認できること

**自動取得（設定不要）**
| 確認したいこと | 指標 |
|---|---|
| 現在のリアルタイムアクセス人数 | Visitors（リアルタイム） |
| 日別・週別ページビュー推移 | Page Views |
| 流入元の内訳（Twitter / Google / 直接等） | Referrers |
| アクセス上位ページ（どのShelfが見られているか） | Top Pages |
| デバイス比率（スマホ / PC） | Devices |
| 国・地域別アクセス | Countries |
| Web Vitals（LCP / CLS / FID）| Performance |

**カスタムイベント（`track()` で実装）**
| 確認したいこと | イベント名 | プロパティ |
|---|---|---|
| アフィリリンククリック数・どちらが多いか | `affiliate_click` | `service: 'amazon'\|'rakuten'`, `isbn`, `shelf_id` |
| Twitterシェアボタン押下数 | `share_twitter` | `shelf_id` |
| URLコピー数 | `share_url_copy` | `shelf_id` |
| 書籍モーダル開封数・どの本が気になられているか | `book_modal_open` | `isbn`, `shelf_id` |
| Shelf作成完了数（登録CVR） | `shelf_created` | `shelf_id` |
| 書籍検索実行数・何を検索しているか | `book_search` | `query` |

## 検討

- OGP画像の表紙取得: Vercel Edge Function 内で楽天/Google Books にサーバサイドfetchして生成

## 憂慮

- 各書影API共通でレート制限が1req/秒 → 並列リクエストを避け、直列処理で実装
- 楽天ブックスAPIのキャッシュ禁止により、表示のたびにAPIリクエストが発生 → レート制限遵守が必要
- Amazon PA APIも短期キャッシュのみ可能 → DB永続保存はしない
- 同一書籍で複数の表紙パターンが返る場合の表示制御
- OGP生成時に楽天/Google Books から表紙をサーバサイドfetchする必要あり
- **Google AdSense とAmazonアソシエイトの共存**: Amazon商品リンクの近くに他社広告を配置することはAmazonアソシエイト規約違反の可能性あり → モーダル内に広告を入れない設計にする

---

想像段階

## ユーザーフレンドリー

- 9以下で登録のとき確認を取る
- 使い方ボタンを右上端に
- 制作者情報もその隣
-
