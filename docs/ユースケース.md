# ユースケース

---

## UC-1: オーガニック検索

**概要**: 検索エンジン経由でサービスを知り、本棚を初投稿する

**前提条件**: 未ログイン状態

### フロー

1. **トップページ** (`/`)
   - サービス説明・使い方を確認
   - 「無料ではじめる」ボタンをクリック

2. **ログイン** (Clerk)
   - Google / GitHub 等でサインアップ or ログイン
   - 完了後 `/me` にリダイレクト

3. **マイページ** (`/me`)
   - 自分の本棚一覧（初回は空）を確認
   - 本棚グリッドの左端にある「＋」カードをクリック

4. **本棚投稿** (`/shelf/new`)
   - 本棚名を入力
   - ISBN or タイトルで書籍を検索・追加（最大9冊）
   - 各本に感想・ネタバレフラグを設定
   - ドラッグ&ドロップで並び替え
   - 「作成する」ボタン → 作成完了後 `/shelf/:id` にリダイレクト

### 完了状態

- 本棚が公開状態で作成されている
- `/shelf/:id` で本棚を確認・シェアできる

---

## UC-2: SNS流入

**概要**: SNSでシェアされた本棚を見た未ログインユーザーがブックマークし、ログイン後もブックマークが保持される

**前提条件**: 未ログイン状態、他ユーザーの本棚URLを開いている

### フロー

1. **本棚閲覧** (`/shelf/:id`) — 未ログイン
   - SNSのリンクから他ユーザーの本棚を閲覧
   - 「保存」（ブックマーク）ボタンをクリック
   - 未ログインのため Clerk ログイン画面に誘導される

2. **ログイン** (Clerk)
   - Google / GitHub 等でサインアップ or ログイン
   - 完了後 `/shelf/:id`（元のページ）に戻る

3. **ブックマーク実行**
   - ログイン済み状態で「保存」ボタンが押せる状態になる
   - ボタンをクリックしてブックマーク完了

4. **マイページ** (`/me`) で確認
   - 「保存した本棚」セクションにブックマークした本棚が表示されている

### 完了状態

- `user_shelf_bookmarks` にレコードが作成されている
- `/me` の「保存した本棚」セクションに対象本棚が表示される

---

## UC-3: アフィリエイトリンク経由の購入

**概要**: 他ユーザーの本棚を閲覧し、気になった本をモーダルから Amazon / 楽天ブックスで購入する

**前提条件**: 未ログイン可（閲覧は認証不要）

### フロー

1. **本棚閲覧** (`/shelf/:id`)
   - SNS・検索・URLから他ユーザーの本棚を開く
   - 書影グリッドに最大9冊が表示される

2. **書籍モーダル表示**
   - 読みたい書影をクリック → モーダルが開く
   - タイトル・著者・登録者のコメント・ネタバレ注意が表示される

3. **購入リンクをクリック**
   - 「Amazon で購入」または「楽天ブックスで購入」ボタンをクリック
   - 新しいタブで各ECサイトに遷移
   - アフィリエイトタグが付与されたURLが使用される

### 完了状態

- `affiliate_click` イベントが Vercel Analytics に記録される（`service: 'amazon'|'rakuten'`, `isbn`, `shelf_id`）
- ユーザーは指定書籍の購入ページに到達している

---

## UC-4: 本棚の編集

**概要**: ログイン済みユーザーが既存の本棚を更新する（本の追加・削除・並び替え・感想修正）

**前提条件**: ログイン済み、自分がオーナーの本棚

### フロー

1. **マイページ** (`/me`) または **本棚閲覧** (`/shelf/:id`)
   - 自分の本棚に「編集」ボタンが表示される
   - クリックで `/shelf/:id/edit` に遷移

2. **本棚編集** (`/shelf/:id/edit`)
   - 本棚名の変更
   - 本の追加（ISBN/タイトル検索 → 追加、最大9冊）
   - 本の削除（各本カードの削除ボタン）
   - ドラッグ&ドロップで並び替え
   - 各本の感想・ネタバレフラグを編集

3. **保存**
   - 「保存する」ボタン → 変更が反映された `/shelf/:id` にリダイレクト

### 完了状態

- `shelves.name` / `shelf_books.review` / `shelf_books.is_spoiler` / `shelf_books.position` が更新されている
- 追加・削除した本も正しく反映されている

---

## UC-5: 本棚の SNS 共有

**概要**: 作成した本棚を Twitter（X）または URL コピーで友人・フォロワーに広める

**前提条件**: ログイン済み（本棚作成直後、または本棚閲覧中）

### フロー

1. **本棚閲覧** (`/shelf/:id`)
   - ページ下部または上部の共有ボタンエリアを確認

2a. **Twitter（X）でシェア**

- 「Twitter でシェア」ボタンをクリック
- `twitter.com/intent/tweet?url=...&text=...` が新しいタブで開く
- 本棚名と URL が本文に入った状態でツイート画面が表示される
- 投稿するとOGP画像付きカードが展開される

2b. **URL コピー**

- 「リンクをコピー」ボタンをクリック
- クリップボードに `/shelf/:id` の完全URLがコピーされる
- ボタン表示が「コピーしました」に変わる（フィードバック）

### 完了状態

- `share_twitter` または `share_url_copy` イベントが Vercel Analytics に記録される
- OGPカードに本棚名・書影が正しく表示される（Twitter / LINE / Slack 等）

---

## UC-6: 気になる本の保存

**概要**: 他ユーザーの本棚に含まれる本を「気になる本」としてブックマークし、マイページで管理する

**前提条件**: ログイン済み

### フロー

1. **本棚閲覧** (`/shelf/:id`)
   - 他ユーザーの本棚を閲覧
   - 書影をクリックしてモーダルを開く

2. **本のブックマーク**
   - モーダル内の「保存」ボタンをクリック
   - `user_book_bookmarks` にレコードが作成される
   - ボタンが「保存済み」状態に変わる（トグル可能）

3. **マイページで確認** (`/me`)
   - 「気になる本」セクションにブックマークした本の書影一覧が表示される
   - 書影クリックで再度モーダルを開ける

### 完了状態

- `user_book_bookmarks` にレコードが存在する
- `/me` の「気になる本」セクションに当該本が表示されている

---

## UC-7: 他ユーザーの本棚一覧閲覧

**概要**: 気になるユーザーのプロフィールページを訪問し、そのユーザーが作成した全本棚を一覧で見る

**前提条件**: 未ログイン可

### フロー

1. **本棚閲覧** (`/shelf/:id`)
   - 本棚オーナーのアバターまたは名前をクリック

2. **ユーザー本棚一覧** (`/users/:userId`)
   - そのユーザーが公開している全本棚がカード形式で表示される
   - 各カードをクリックで個別の `/shelf/:id` に遷移

### 完了状態

- 対象ユーザーの全 shelf（削除済みを除く）が表示されている
- 各本棚カードに本棚名・書影サムネイル・閲覧数が表示される

---

## UC-8: 複数本棚の管理

**概要**: ジャンル別・年ベスト別など複数の本棚を作成・整理し、マイページで管理する

**前提条件**: ログイン済み、既に1つ以上の本棚を作成済み

### フロー

1. **マイページ** (`/me`)
   - 既存の「自分の本棚」一覧を確認
   - 本棚グリッドの左端にある「＋」カードをクリック

2. **本棚投稿** (`/shelf/new`)
   - 新しいテーマの本棚名を入力（例: "2025年のベスト9"）
   - 書籍を最大9冊追加・並び替え
   - 「作成する」→ 作成完了

3. **本棚の削除**
   - マイページや本棚ページから不要な本棚を削除
   - 削除後はリストから消える（公開URLも無効になる）

### 完了状態

- `/me` に複数の本棚カードが表示されている
- 各本棚は独立した `/shelf/:id` を持つ
- 削除した本棚の URL にアクセスすると 404 または「見つかりません」が表示される

---

## UC-9: /feed タイムラインで本棚を発見・Save

**概要**: /feed で本棚を縦スワイプしながら閲覧し、気になった本棚を左右スワイプでブックマークする

**前提条件**: 未ログイン または ログイン済み

### フロー

1. **/feed** (`/feed`)
   - 下部タブ（PCは左サイドバー）の「フィード」をタップ
   - 本棚が1枚ずつフルスクリーンで表示される
   - 上部のソートタブで「新着順 / ブックマーク数順 / おすすめ」を切替可能

2. **縦スワイプで閲覧**
   - 下にスワイプ or マウスホイールで次の本棚へ（GSAPアニメーション付き）
   - PCは ↑↓ キーで操作可能
   - 未ログインの場合、30回スワイプで上限に達しログイン誘導モーダルが表示される

3a. **ブックマーク（ログイン済み）**

- 右スワイプ → ブックマーク追加（ハートアニメーション）
- 左スワイプ → ブックマーク解除
- `/me` の「保存した本棚」に反映される

3b. **ブックマーク（未ログイン → 上限到達後）**

- 左右スワイプしてもブックマークは登録されない
- 30回到達後: Clerkログイン画面へ誘導される

### 完了状態

- ログイン済み: `user_shelf_bookmarks` にレコードが作成されている
- `feed_guest_limit_reached` イベントが Analytics に記録される（未ログイン離脱計測）

---

## UC-10: 検索から本棚を発見

**概要**: `/search` でキーワード or 例示タグから本棚を探し、閲覧 or ブックマークする

**前提条件**: 未ログイン可

### フロー

1. **検索ページ** (`/search`)
   - 下部タブ（PCは左サイドバー）の「検索」をタップ
   - テキストボックスにキーワードを入力 **or** 下に並んだ例示タグをタップ
     - `私をかたちづくる本` / `ライトノベル` / `ミステリー` / `2025年BEST` / `おすすめ`

2. **検索結果の閲覧**
   - 本棚名にヒットした本棚カード一覧が表示される
   - カードをクリックで `/shelf/:id` へ遷移

3. **本棚を保存**（ログイン済みの場合）
   - `/shelf/:id` で「保存」ボタンをクリックしブックマーク

### 完了状態

- 入力キーワードにマッチする本棚一覧が表示されている
- 事前に選んだ例示タグが検索ボックスに自動入力され橋渡しなく検索できる

---

## UC-11: アカウント設定（名前変更・退会）

**概要**: マイページの設定から表示名を変更する、またはアカウントを退会する

**前提条件**: ログイン済み

### フロー（名前変更）

1. **マイページ** (`/me`)
   - 設定アイコン（歯車等）をタップ → 設定モーダルが開く
   - 表示名入力欄に新しい名前を入力
   - 「保存」ボタン → `PATCH /api/users/:userId` で `display_name` を更新
   - モーダルが閉じ、ページの表示名が即座に反映される

### フロー（退会）

1. **設定モーダル**
   - 「アカウントを削除」ボタンをタップ
   - 確認テキスト（「「delete」と入力してください」等）を入力
   - `DELETE /api/users/:userId` 実行 → `users.deleted_at` に現在時刻を記録（ソフトデリート）
   - Clerk `signOut()` → `/`（トップ）へリダイレクト

### 完了状態

- 名前変更: `users.display_name` が更新されている
- 退会: `users.deleted_at IS NOT NULL` となり、本棚の作者名が「退会済みユーザー」に変わる

---

## 備考

- UC-2 においてログイン前のブックマーク操作は保持されない（ログイン後に再度クリックが必要）
- 将来的には `redirect_url` を使いログイン後に自動ブックマーク実行することも検討できる
- UC-3 のアフィリエイトリンクは運営者（自分）固定のタグを使用。同一ISBNを別ユーザーが登録してもタグは上書きされる
- モーダル内への広告配置は Amazon アソシエイト規約の懸念から行わない（UC-3 と競合するため）
