# タスク計画書

## 関連ファイル

- `docs/要件定義.md` - 要件定義
- `app/db/schema.ts` - DBスキーマ（完成済み）
- `app/db/index.ts` - Turso接続（完成済み）
- `app/root.tsx` - ルートレイアウト（Clerk + clerkMiddleware + Analytics 設定済み）
- `app/routes.ts` - ルート定義（全スタブ作成済み）
- `app/lib/auth.server.ts` - 認証ユーティリティ（✅ 完了）
- `app/routes/api.webhooks.clerk.ts` - Webhook（✅ 完了）
- `app/routes/api.books.search.ts` - 書籍検索（✅ 完了）
- `app/lib/rakuten.ts` - 楽天ブックス API クライアント（✅ 完了）
- `app/lib/google-books.ts` - Google Books API クライアント（✅ 完了）
- `app/types/book.ts` - BookSearchResult 型定義（✅ 完了）
- `app/routes/api.shelves.ts` - Shelf作成（スタブ）
- `app/routes/api.shelves.$id.ts` - Shelf取得・更新・削除（スタブ）
- `app/routes/api.shelves.$id.view.ts` - 閲覧数（スタブ）
- `app/routes/api.shelves.$id.books.ts` - 本追加（スタブ）
- `app/routes/api.shelves.$id.books.$isbn.ts` - 本更新・削除（スタブ）
- `app/routes/api.shelves.$id.books.reorder.ts` - 並び順（スタブ）
- `app/routes/api.users.$userId.shelves.ts` - ユーザーShelf一覧（スタブ）
- `app/routes/api.og.$shelfId.ts` - OG画像（スタブ）
- `app/routes/home.tsx` - トップページ（スタブ）
- `app/routes/shelf.new.tsx` - Shelf作成ページ（スタブ）
- `app/routes/shelf.$id.tsx` - Shelf閲覧ページ（スタブ）
- `app/routes/shelf.$id.edit.tsx` - Shelf編集ページ（スタブ）
- `app/routes/me.tsx` - マイページ（スタブ）
- `app/routes/users.$userId.tsx` - 他ユーザーページ（スタブ）

---

## フェーズ一覧

| フェーズ | 内容                                   | 優先度 |
| -------- | -------------------------------------- | ------ | ----------- |
| 1        | 認証基盤（Clerk Webhook + 保護ルート） | 最高   | ✅ ほぼ完了 |
| 2        | 書籍検索 API                           | 高     | ✅ 完了     |
| 3        | Shelf CRUD API                         | 高     | ✅ 完了     |
| 4        | Shelf閲覧ページ（コア機能）            | 高     | ✅ 完了     |
| 5        | Shelf作成・編集ページ                  | 高     |             |
| 6        | トップページ（ランディング）           | 中     |             |
| 7        | マイページ・他ユーザーページ           | 中     |             |
| 8        | SNS共有                                | 中     |             |
| 9        | OGP（動的OG画像）                      | 中     |             |
| 10       | Analytics カスタムイベント             | 低     |             |
| 11       | v2: いいね/ブックマーク                | 低     |             |

---

## フェーズ 1: 認証基盤

### 1-1. Clerk Webhook（`api/webhooks/clerk`）

- [x] Svix パッケージインストール（`bun add svix`）
- [x] Webhook署名検証（`svix` で `CLERK_WEBHOOK_SECRET` を使って検証）
- [x] `user.created` イベントで `users` テーブルに insert
- [x] `user.updated` イベントで `users` テーブルを update（displayName / avatarUrl）
- [ ] Clerk ダッシュボードで Webhook エンドポイントを登録
- [x] `CLERK_WEBHOOK_SECRET` を `.env` に追加

### 1-2. 認証保護ミドルウェア

- [x] `app/lib/auth.server.ts` を作成（`requireAuth` / `requireAuthApi` ユーティリティ）
- [x] `clerkMiddleware()` を `root.tsx` に設定、`v8_middleware` フラグ有効化
- [x] API route（POST/PATCH/DELETE）でサーバーサイドの認証確認ユーティリティを作成
- [ ] `/shelf/new`、`/shelf/:id/edit`、`/me` の loader に `requireAuth` を適用

---

## フェーズ 2: 書籍検索 API

### 2-1. `GET /api/books/search?q={query}`

- [x] 楽天ブックス API クライアント実装（`app/lib/rakuten.ts`）
  - タイトル・著者・ISBN・書影URLを返す
- [x] Google Books API クライアント実装（`app/lib/google-books.ts`）
  - タイトル・著者・ISBN・書影URLを返す
- [x] 並列 fetch で楽天 + Google Books を同時に叩く
- [x] 結果を統合・重複除去（ISBNキーで dedup）
- [x] レスポンス型定義（`app/types/book.ts`）
- [x] `api.books.search.ts` に実装

---

## フェーズ 3: Shelf CRUD API

### 3-1. `POST /api/shelves`（Shelf作成）

- [x] 認証確認（未認証は 401）
- [x] UUID生成（`crypto.randomUUID()`）
- [x] `shelves` テーブルに insert
- [x] 作成した shelf を返す

### 3-2. `GET /api/shelves/:id`（Shelf取得）

- [x] `shelves` + `shelf_books` を JOIN して取得
- [x] `shelf_books` を position 順にソート
- [x] `books` から `affiliate_url` を取得してマージ
- [x] 404ハンドリング

### 3-3. `PATCH /api/shelves/:id`（Shelf名変更）

- [x] 認証確認 + オーナーチェック
- [x] `name` を更新、`updated_at` も更新

### 3-4. `DELETE /api/shelves/:id`（Shelf削除）

- [x] 認証確認 + オーナーチェック
- [x] CASCADE で `shelf_books` も削除される（schema設定済み）

### 3-5. `POST /api/shelves/:id/view`（閲覧数インクリメント）

- [x] `view_count` を +1 する

### 3-6. `POST /api/shelves/:id/books`（本を追加）

- [x] 認証確認 + オーナーチェック
- [x] 最大9冊チェック（9冊超えは 400）
- [x] `books` テーブルに isbn + affiliate URL を upsert
- [x] `shelf_books` に insert

### 3-7. `PATCH /api/shelves/:id/books/:isbn`（感想・ネタバレ・順番更新）

- [x] 認証確認 + オーナーチェック
- [x] `review`、`is_spoiler`、`position` を部分更新

### 3-8. `DELETE /api/shelves/:id/books/:isbn`（本を削除）

- [x] 認証確認 + オーナーチェック
- [x] `shelf_books` から削除

### 3-9. `PATCH /api/shelves/:id/books/reorder`（並び順一括更新）

- [x] 認証確認 + オーナーチェック
- [x] `[{ isbn, position }]` 配列を受け取り一括更新

### 3-10. `GET /api/users/:userId/shelves`（ユーザーのShelf一覧）

- [x] `shelves` を `user_id` でフィルタして返す

---

## フェーズ 4: Shelf閲覧ページ（`/shelf/:id`）

### 4-1. データ取得

- [x] `loader` で DB を直接クエリして shelf データ取得
- [x] `view_count` インクリメント（fire & forget）
- [x] 書影取得: isbn をキーに `/api/books/search` を useEffect で並列フェッチ

### 4-2. UI

- [x] 9冊グリッドレイアウト（3×3）
- [x] Skeleton UI（書影取得中のプレースホルダー）
- [x] 書影のプログレッシブ表示（取得完了次第差し替え）

### 4-3. 書籍モーダル

- [x] 表紙クリック → モーダル表示
- [x] 書籍情報（タイトル・著者）表示
- [x] 感想・紹介文表示（`review`）
- [x] ネタバレ本は感想･紹介文デフォルト隠し表示 + タップで解除
- [x] Amazonアフィリエイトリンクボタン
- [x] 楽天アフィリエイトリンクボタン
- [ ] `affiliate_click` カスタムイベント送信（フェーズ10で実装）

---

## フェーズ 5: Shelf作成・編集ページ

### 5-1. Shelf作成ページ（`/shelf/new`）

- [ ] Shelf名入力フォーム
- [ ] 書籍検索UI（`/api/books/search` を call）
- [ ] 検索結果から本を選択（最大9冊）
- [ ] 各本に感想・ネタバレフラグを入力
- [ ] ドラッグ&ドロップで並び替え
- [ ] 作成ボタン → `POST /api/shelves` → `POST /api/shelves/:id/books` を順に call
- [ ] 9冊未満で登録時に確認モーダルを表示
- [ ] 作成完了後 `/shelf/:id` にリダイレクト
- [ ] `shelf_created` カスタムイベント送信

### 5-2. Shelf編集ページ（`/shelf/:id/edit`）

- [ ] オーナーのみアクセス可（非オーナーは 403）
- [ ] 既存データの読み込み・編集
- [ ] 本の追加・削除・並び替え
- [ ] 感想・ネタバレ編集
- [ ] 保存 → 完了後 `/shelf/:id` にリダイレクト

---

## フェーズ 6: トップページ（`/`）

- [ ] サービス説明・使い方の案内
- [ ] ログインボタン / マイページへのリンク
- [ ] 新着・人気 Shelf のサンプル表示（任意）

---

## フェーズ 7: マイページ・他ユーザーページ

### 7-1. マイページ（`/me`）

- [ ] `GET /api/users/:userId/shelves` で自分の Shelf 一覧取得
- [ ] Shelf カード一覧表示（名前・本のサムネイル・閲覧数）
- [ ] 新規作成ボタン → `/shelf/new`
- [ ] Shelf削除ボタン

### 7-2. 他ユーザーページ（`/users/:userId`）

- [ ] `GET /api/users/:userId/shelves` で Shelf 一覧取得
- [ ] Shelf カード一覧表示（読み取り専用）

---

## フェーズ 8: SNS共有

- [ ] Twitter Web Intent URLでツイートボタン実装
  - `https://twitter.com/intent/tweet?url={url}&text={title}`
- [ ] URLコピーボタン（`navigator.clipboard.writeText()`）
- [ ] `share_twitter` / `share_url_copy` カスタムイベント送信

---

## フェーズ 9: OGP（動的OG画像）

- [ ] `@vercel/og` パッケージインストール（`bun add @vercel/og`）
- [ ] `GET /api/og/:shelfId` に Vercel Edge Function として実装
- [ ] shelf 名 + 書影（最大9枚）をサーバーサイドfetch して画像生成
- [ ] `<meta property="og:image">` を各ページの `meta` 関数で設定

---

## フェーズ 10: Analytics カスタムイベント

Vercel Analytics の `track()` を使って以下を計測:

| 実装箇所       | イベント名        | プロパティ                                         |
| -------------- | ----------------- | -------------------------------------------------- |
| 書籍モーダル   | `book_modal_open` | `isbn`, `shelf_id`                                 |
| アフィリリンク | `affiliate_click` | `service: 'amazon'\|'rakuten'`, `isbn`, `shelf_id` |
| Twitterシェア  | `share_twitter`   | `shelf_id`                                         |
| URLコピー      | `share_url_copy`  | `shelf_id`                                         |
| Shelf作成完了  | `shelf_created`   | `shelf_id`                                         |
| 書籍検索       | `book_search`     | `query`                                            |

---

## フェーズ 11: v2 - いいね/ブックマーク

### 11-1. Shelfブックマーク

- [ ] `POST /api/shelves/:id/bookmarks`（ブックマーク追加）
- [ ] `DELETE /api/shelves/:id/bookmarks`（ブックマーク解除）
- [ ] `shelves.likes_count` を更新
- [ ] Shelf閲覧ページにいいねボタン追加

### 11-2. 本ブックマーク

- [ ] `POST /api/books/:isbn/bookmarks`（ブックマーク追加）
- [ ] `DELETE /api/books/:isbn/bookmarks`（ブックマーク解除）
- [ ] マイページに「気になる本リスト」表示

---

## 現在の進捗

| カテゴリ                      | 状況                                      |
| ----------------------------- | ----------------------------------------- |
| プロジェクトセットアップ      | ✅ 完了                                   |
| DBスキーマ（Drizzle + Turso） | ✅ 完了                                   |
| Clerk 認証統合                | ✅ 完了（ClerkProvider + rootAuthLoader） |
| Vercel Analytics 統合         | ✅ 完了                                   |
| ESLint + typecheck            | ✅ 完了                                   |
| 全ルートスタブ                | ✅ 完了                                   |
| フェーズ 1: 認証基盤          | 🔲 未着手                                 |
| フェーズ 2: 書籍検索 API      | 🔲 未着手                                 |
| フェーズ 3〜11                | 🔲 未着手                                 |
