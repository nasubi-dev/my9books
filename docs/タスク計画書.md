# タスク計画書

## 関連ファイル

- `docs/要件定義.md` - 要件定義
- `app/db/schema.ts` - DBスキーマ（完成済み）
- `app/db/index.ts` - Turso接続（完成済み）
- `app/root.tsx` - ルートレイアウト（Clerk + clerkMiddleware + Analytics 設定済み）
- `app/routes.ts` - ルート定義（全スタブ作成済み）
- `app/lib/auth.server.ts` - 認証ユーティリティ（✅ 完了）
- `app/routes/api.webhooks.clerk.ts` - Webhook（✅ 完了）
- `app/routes/api.books.search.ts` - 書籍検索（✅ 完了）
- `app/lib/rakuten.ts` - 楽天ブックス API クライアント（✅ 完了）
- `app/lib/google-books.ts` - Google Books API クライアント（✅ 完了）
- `app/types/book.ts` - BookSearchResult 型定義（✅ 完了）
- `app/routes/api.shelves.ts` - Shelf作成（スタブ）
- `app/routes/api.shelves.$id.ts` - Shelf取得・更新・削除（スタブ）
- `app/routes/api.shelves.$id.view.ts` - 閲覧数（スタブ）
- `app/routes/api.shelves.$id.books.ts` - 本追加（スタブ）
- `app/routes/api.shelves.$id.books.$isbn.ts` - 本更新・削除（スタブ）
- `app/routes/api.shelves.$id.books.reorder.ts` - 並び順（スタブ）
- `app/routes/api.users.$userId.shelves.ts` - ユーザーShelf一覧（スタブ）
- `app/routes/api.og.$shelfId.ts` - OG画像（スタブ）
- `app/routes/home.tsx` - トップページ（スタブ）
- `app/routes/shelf.new.tsx` - Shelf作成ページ（スタブ）
- `app/routes/shelf.$id.tsx` - Shelf閲覧ページ（スタブ）
- `app/routes/shelf.$id.edit.tsx` - Shelf編集ページ（スタブ）
- `app/routes/me.tsx` - マイページ（スタブ）
- `app/routes/users.$userId.tsx` - 他ユーザーページ（スタブ）

---

## フェーズ一覧

| フェーズ | 内容                                   | 優先度 |
| -------- | -------------------------------------- | ------ | ----------- |
| 1        | 認証基盤（Clerk Webhook + 保護ルート） | 最高   | ✅ ほぼ完了 |
| 2        | 書籍検索 API                           | 高     | ✅ 完了     |
| 3        | Shelf CRUD API                         | 高     | ✅ 完了     |
| 4        | Shelf閲覧ページ（コア機能）            | 高     | ✅ 完了     |
| 5        | Shelf作成・編集ページ                  | 高     | ✅ 完了     |
| 6        | トップページ（ランディング）           | 中     | ✅ 完了     |
| 7        | マイページ・他ユーザーページ           | 中     | ✅ 完了     |
| 8        | SNS共有                                | 中     | ✅ 完了     |
| 9        | UI文言・コピー管理                     | 中     | ✅ 完了     |
| 10       | Analytics カスタムイベント             | 低     | ✅ 完了     |
| 11       | OGP（動的OG画像）                      | 低     | ✅ 完了     |
| 12       | v2: いいね/ブックマーク                | 低     | ✅ 完了     |
| 12.6     | 書影リクエスト最適化（キャッシュ）     | 低     | ✅ 完了     |
| 13       | SEO対策                                | 高     | 🔲 未着手   |
| 14       | 共通レイアウト（ヘッダー・タブ・検索） | 高     | 🔲 未着手   |
| 15       | /feed タイムライン                     | 高     | 🔲 未着手   |
| 16       | マイページ改善・top フッター           | 中     | 🔲 未着手   |
| 17       | v3: 通知機能                           | 低     | 🔲 未着手   |

---

## フェーズ 1: 認証基盤

### 1-1. Clerk Webhook（`api/webhooks/clerk`）

- [x] Svix パッケージインストール（`bun add svix`）
- [x] Webhook署名検証（`svix` で `CLERK_WEBHOOK_SECRET` を使って検証）
- [x] `user.created` イベントで `users` テーブルに insert
- [x] `user.updated` イベントで `users` テーブルを update（displayName / avatarUrl）
- [ ] Clerk ダッシュボードで Webhook エンドポイントを登録
- [x] `CLERK_WEBHOOK_SECRET` を `.env` に追加

### 1-2. 認証保護ミドルウェア

- [x] `app/lib/auth.server.ts` を作成（`requireAuth` / `requireAuthApi` ユーティリティ）
- [x] `clerkMiddleware()` を `root.tsx` に設定、`v8_middleware` フラグ有効化
- [x] API route（POST/PATCH/DELETE）でサーバーサイドの認証確認ユーティリティを作成
- [ ] `/shelf/new`、`/shelf/:id/edit`、`/me` の loader に `requireAuth` を適用

---

## フェーズ 2: 書籍検索 API

### 2-1. `GET /api/books/search?q={query}`

- [x] 楽天ブックス API クライアント実装（`app/lib/rakuten.ts`）
  - タイトル・著者・ISBN・書影URLを返す
- [x] Google Books API クライアント実装（`app/lib/google-books.ts`）
  - タイトル・著者・ISBN・書影URLを返す
- [x] 並列 fetch で楽天 + Google Books を同時に叩く
- [x] 結果を統合・重複除去（ISBNキーで dedup）
- [x] レスポンス型定義（`app/types/book.ts`）
- [x] `api.books.search.ts` に実装

---

## フェーズ 3: Shelf CRUD API

### 3-1. `POST /api/shelves`（Shelf作成）

- [x] 認証確認（未認証は 401）
- [x] UUID生成（`crypto.randomUUID()`）
- [x] `shelves` テーブルに insert
- [x] 作成した shelf を返す

### 3-2. `GET /api/shelves/:id`（Shelf取得）

- [x] `shelves` + `shelf_books` を JOIN して取得
- [x] `shelf_books` を position 順にソート
- [x] `books` から `affiliate_url` を取得してマージ
- [x] 404ハンドリング

### 3-3. `PATCH /api/shelves/:id`（Shelf名変更）

- [x] 認証確認 + オーナーチェック
- [x] `name` を更新、`updated_at` も更新

### 3-4. `DELETE /api/shelves/:id`（Shelf削除）

- [x] 認証確認 + オーナーチェック
- [x] CASCADE で `shelf_books` も削除される（schema設定済み）

### 3-5. `POST /api/shelves/:id/view`（閲覧数インクリメント）

- [x] `view_count` を +1 する

### 3-6. `POST /api/shelves/:id/books`（本を追加）

- [x] 認証確認 + オーナーチェック
- [x] 最大9冊チェック（9冊超えは 400）
- [x] `books` テーブルに isbn + affiliate URL を upsert
- [x] `shelf_books` に insert

### 3-7. `PATCH /api/shelves/:id/books/:isbn`（感想・ネタバレ・順番更新）

- [x] 認証確認 + オーナーチェック
- [x] `review`、`is_spoiler`、`position` を部分更新

### 3-8. `DELETE /api/shelves/:id/books/:isbn`（本を削除）

- [x] 認証確認 + オーナーチェック
- [x] `shelf_books` から削除

### 3-9. `PATCH /api/shelves/:id/books/reorder`（並び順一括更新）

- [x] 認証確認 + オーナーチェック
- [x] `[{ isbn, position }]` 配列を受け取り一括更新

### 3-10. `GET /api/users/:userId/shelves`（ユーザーのShelf一覧）

- [x] `shelves` を `user_id` でフィルタして返す

---

## フェーズ 4: Shelf閲覧ページ（`/shelf/:id`）

### 4-1. データ取得

- [x] `loader` で DB を直接クエリして shelf データ取得
- [x] `view_count` インクリメント（fire & forget）※作者自身のアクセスはカウント除外
- [x] 書影取得: isbn をキーに `/api/books/search` を useEffect で並列フェッチ

### 4-2. UI

- [x] 9冊グリッドレイアウト（3×3）
- [x] Skeleton UI（書影取得中のプレースホルダー）
- [x] 書影のプログレッシブ表示（取得完了次第差し替え）

### 4-3. 書籍モーダル

- [x] 表紙クリック → モーダル表示
- [x] 書籍情報（タイトル・著者）表示
- [x] 感想・紹介文表示（`review`）
- [x] ネタバレ本は感想･紹介文デフォルト隠し表示 + タップで解除
- [x] Amazonアフィリエイトリンクボタン
- [x] 楽天アフィリエイトリンクボタン
- [x] `affiliate_click` カスタムイベント送信（フェーズ10で実装）

---

## フェーズ 5: Shelf作成・編集ページ

### 5-1. Shelf作成ページ（`/shelf/new`）

- [x] Shelf名入力フォーム
- [x] 書籍検索UI（`/api/books/search` を call）
- [x] 検索結果から本を選択（最大9冊）
- [x] 各本に感想・ネタバレフラグを入力
- [x] ドラッグ&ドロップで並び替え
- [x] 作成ボタン → `POST /api/shelves` → `POST /api/shelves/:id/books` を順に call
- [x] 9冊未満で登録時に確認モーダルを表示
- [x] 作成完了後 `/shelf/:id` にリダイレクト
- [x] `shelf_created` カスタムイベント送信（フェーズ10で実装）

### 5-2. Shelf編集ページ（`/shelf/:id/edit`）

- [x] オーナーのみアクセス可（非オーナーは 403）
- [x] 既存データの読み込み・編集
- [x] 本の追加・削除・並び替え
- [x] 感想・ネタバレ編集
- [x] 保存 → 完了後 `/shelf/:id` にリダイレクト

---

## フェーズ 6: トップページ（`/`）

- [ ] サービス説明・使い方の案内
- [ ] ログインボタン / マイページへのリンク
- [ ] 新着・人気 Shelf のサンプル表示（任意）

---

## フェーズ 7: マイページ・他ユーザーページ

### 7-1. マイページ（`/me`）

- [x] `GET /api/users/:userId/shelves` で自分の Shelf 一覧取得
- [x] Shelf カード一覧表示（名前・本のサムネイル・閲覧数）
- [x] 新規作成ボタン → `/shelf/new`
- [x] Shelf削除ボタン
- [x] 編集ボタン → `/shelf/:id/edit`（キャンセルで `/me` に戻る）

### 7-2. 他ユーザーページ（`/users/:userId`）

- [x] `GET /api/users/:userId/shelves` で Shelf 一覧取得
- [x] Shelf カード一覧表示（読み取り専用）

---

## フェーズ 8: SNS共有

- [x] Twitter Web Intent URLでツイートボタン実装
  - `https://twitter.com/intent/tweet?url={url}&text={title}`
- [x] URLコピーボタン（`navigator.clipboard.writeText()`）
- [x] `share_twitter` / `share_url_copy` カスタムイベント送信（フェーズ10で実装）

---

## フェーズ 9: UI文言・コピー管理

- [x] `app/lib/copy.ts` を作成（TypeScript const オブジェクト）
  - サイト名・キャッチコピー・ハッシュタグ定数
  - Twitter共有文（`shelfName` を受け取る関数）
  - OGタイトル・OGディスクリプション関数
- [x] `shelf.$id.tsx` の共有テキストを `COPY` から参照するよう変更
- [x] `me.tsx` / `shelf.new.tsx` / `shelf.$id.edit.tsx` / `users.$userId.tsx` でも `COPY` を使用
- [ ] トップページ（フェーズ6）・OGP（フェーズ11）でも `COPY` を使用

---

## フェーズ 10: Analytics カスタムイベント

Vercel Analytics の `track()` を使って以下を計測:

| 実装箇所       | イベント名        | プロパティ                                         | 状態 |
| -------------- | ----------------- | -------------------------------------------------- | ---- |
| 書籍モーダル   | `book_modal_open` | `isbn`, `shelf_id`                                 | ✅   |
| アフィリリンク | `affiliate_click` | `service: 'amazon'\|'rakuten'`, `isbn`, `shelf_id` | ✅   |
| Twitterシェア  | `share_twitter`   | `shelf_id`                                         | ✅   |
| URLコピー      | `share_url_copy`  | `shelf_id`                                         | ✅   |
| Shelf作成完了  | `shelf_created`   | `shelf_id`                                         | ✅   |
| 書籍検索       | `book_search`     | `query`                                            | ✅   |

---

## フェーズ 11: OGP（動的OG画像）

- [x] `@vercel/og` パッケージインストール（`bun add @vercel/og`）
- [x] `GET /api/og/:shelfId` ぞ Shelf専用動的OG画像生成（`app/routes/api.og.$shelfId.tsx`）
  - Shelf名（大文字）+ 書籍冊数を左重に表示
  - 右側に9色の本の背表紙アニメーション
- [x] `GET /api/og-default` でデフォルトOG画像生成（`app/routes/api.og.default.tsx`）
  - アイコンプレースホルダー（後で差し替え可）+ my9books + キャッチコピー
- [x] `shelf.$id.tsx` に `meta()` を追加 → Shelfページのみ動的OG指定
- [x] `root.tsx` に `meta()` を追加 → 全ページ共通のデフォルトOG
- [x] OGテキストは `COPY`（フェーズ9）から参照

---

## フェーズ 12: v2 - いいね/ブックマーク

### 関連ファイル

- `app/db/schema.ts` - `userShelfBookmarks` / `userBookBookmarks` / `userShelfLikes`（追加予定）
- `app/routes/api.shelves.$id.bookmarks.ts` - Shelf ブックマーク API（新規）
- `app/routes/api.shelves.$id.likes.ts` - Shelf いいね API（新規）
- `app/routes/api.books.$isbn.bookmarks.ts` - 本 ブックマーク API（新規）
- `app/routes/shelf.$id.tsx` - いいね・ブックマークボタン追加
- `app/routes/me.tsx` - ブックマーク/いいね済みShelf・本のセクション追加

### 12-0. DBスキーマ追加 + マイグレーション

- [x] `userShelfLikes` テーブルを `schema.ts` に追加（`user_shelf_likes`）
- [x] `shelves.bookmarks_count` カラム追加
- [x] Turso に `scripts/migrate-phase12.ts` でマイグレーション実行（`user_shelf_likes`・`user_shelf_bookmarks`・`user_book_bookmarks`・`bookmarks_count`全て完了）
- [x] `userBookBookmarks` テーブルを `schema.ts` に追加（`user_book_bookmarks`）

### 12-1. Shelf いいね API（`api/shelves/:id/likes`）

- [x] `app/routes/api.shelves.$id.likes.ts` を作成
- [x] `POST` → `user_shelf_likes` に insert、`shelves.likes_count` を +1
- [x] `DELETE` → `user_shelf_likes` から delete、`shelves.likes_count` を -1（0未満にならないよう clamp）
- [x] 未認証は 401
- [x] `routes.ts` にルート追加

### 12-2. Shelf ブックマーク API（`api/shelves/:id/bookmarks`）

- [x] `app/routes/api.shelves.$id.bookmarks.ts` を作成
- [x] `POST` → `user_shelf_bookmarks` に insert、`shelves.bookmarks_count` を +1
- [x] `DELETE` → `user_shelf_bookmarks` から delete、`shelves.bookmarks_count` を -1
- [x] 未認証は 401
- [x] `routes.ts` にルート追加

### 12-3. 本 ブックマーク API（`api/books/:isbn/bookmarks`）

- [x] `app/routes/api.books.$isbn.bookmarks.ts` を作成
- [x] `POST` → `user_book_bookmarks` に insert
- [x] `DELETE` → `user_book_bookmarks` から delete
- [x] 未認証は 401
- [x] `routes.ts` にルート追加
- [x] **本のいいね機能は不要と判断 → 実装・DBともに削除**（`user_book_likes` テーブルは作成後に DROP）

### 12-4. Shelf閲覧ページにいいね・ブックマークボタン追加（`shelf.$id.tsx`）

- [x] loader でログインユーザーの `liked` / `bookmarked` フラグを取得して返す
- [x] ❤️ いいね数 + いいねトグルボタン（未ログイン時はCTA）
- [x] 🔖 ブックマークトグルボタン（未ログイン時はCTA）
- [x] ボタン押下時に `POST/DELETE /api/shelves/:id/likes` か `bookmarks` をfetch
- [x] 書籍モーダルに本の「保存」ボタン追加（`/api/books/:isbn/bookmarks`）
  - **ポリシー変更**: 本単体はいいね不要・ブックマーク（保存）のみ

### 12-5. マイページに2セクション追加（`me.tsx`）

- [x] loader でブックマーク済みShelf（最大4件）・ブックマーク済み本（最大4件）を取得
- [x] **保存した本棚 セクション**（先頭3件カード表示・4件超は件数表示）
- [x] **気になる本 セクション**（書影+ブックマーク解除ボタン）
- [x] セクションが空の場合は非表示
- [x] **いいねした本棚セクションは非表示**（要件変更・実装なし）

---

## フェーズ 12.6: 書影リクエスト最適化（キャッシュ）

> 楽天/Google Books API のレート制限エラー対策として追加実装。

### 関連ファイル

- `app/lib/book-meta-cache.ts` - サーバーサイドインメモリキャッシュ本体（新規）
- `app/routes/api.books.search.ts` - キャッシュ参照・書き込み
- `app/routes/api.books.cache-status.ts` - 複数ISBNキャッシュ一括チェックAPI（新規）
- `app/routes.ts` - `api/books/cache-status` ルート追加
- `app/routes/shelf.$id.tsx` - 2フェーズfetch
- `app/routes/me.tsx` - 2フェーズfetch
- `.env` / `.env.example` - `BOOK_META_CACHE_ENABLED` フラグ追加
- `docs/reports/20260228120000-book-meta-cache-removal.md` - 剥がし方ガイド

### 実装内容

- [x] `app/lib/book-meta-cache.ts` を作成（TTL 24h のインメモリ Map + `getBatchCacheStatus` 関数）
- [x] `api.books.search.ts` にキャッシュ参照・書き込みを追加
  - **書影なし・空結果はキャッシュしない**（失敗時に再取得できるよう）
  - `.env` の `BOOK_META_CACHE_ENABLED=false` で即時無効化可能
- [x] `GET /api/books/cache-status?isbns=...` エンドポイント作成（外部API不使用）
- [x] `shelf.$id.tsx` / `me.tsx` を **2フェーズfetch** に変更
  - Phase 1: cache-status を1回叩き、キャッシュ済みISBNを全件一括表示
  - Phase 2: 未キャッシュISBNのみ 200ms stagger でリクエスト分散
  - ページ離脱時は `AbortController.abort()` でキャンセル

---

## フェーズ 13: SEO対策

### 関連ファイル

- `app/routes/home.tsx` - トップページ（meta 関数追加）
- `app/routes/shelf.$id.tsx` - 本棚詳細（本棚名・書籍名を title に含める）
- `app/routes/me.tsx` - マイページ
- `app/routes/feed.tsx` - タイムライン（新規）
- `app/routes/search.tsx` - 検索ページ（新規）
- `public/robots.txt` - クローラー制御（新規作成）
- `app/routes/sitemap[.xml].tsx` - サイトマップ生成（新規）

### 13-1. ページごとの meta タグ

- [ ] `home.tsx`: title = "my9books — 9冊で伝える、あなたの本棚" / description
- [ ] `shelf.$id.tsx`: title = "<本棚名> by <ユーザー名> | my9books" / og:description に書籍名リスト
- [ ] `me.tsx`, `feed.tsx`, `search.tsx`: 各ページに適切な title / description を設定
- [ ] React Router v7 の `meta` 関数を使用（`export const meta: MetaFunction = () => [...] `）

### 13-2. robots.txt

- [ ] `public/robots.txt` を作成
  - `User-agent: *` / `Allow: /`
  - `Disallow: /api/`
  - `Sitemap: https://my9books.com/sitemap.xml`

### 13-3. sitemap.xml 自動生成

- [ ] `app/routes/sitemap[.xml].tsx` に loader を実装
  - 静的ルート（`/`, `/feed`, `/search`）を含める
  - 全 shelf の `/shelf/:id`（削除済み除く）を動的生成
  - `lastmod` に `shelves.updated_at` を使用
  - `Content-Type: application/xml` で返す

---

## フェーズ 14: 共通レイアウト（ヘッダー・ナビゲーション・検索）

> **設計指针**: スマホでの動作を最優先とする。PCでは画面左側にサイドバーを表示し、スマホの下部タブ山容を包括する。

### レイアウト戦略

| 対象            | ナビゲーション                                            | 備考                             |
| --------------- | --------------------------------------------------------- | -------------------------------- |
| スマホ (`< lg`) | **ヘッダー**（上局）+ **下部タブ**（5タブ）               | ヘッダーにロゴ・作者アイコンのみ |
| PC (`≥ lg`)     | **左サイドバー**（固定）+ ヘッダー非表示 + 下部タブ非表示 | サイドバー幅 240px程度           |

### 関連ファイル

- `app/components/AppShell.tsx` — レイアウト切替コンテナ（新規）
- `app/components/Header.tsx` — スマホ専用ヘッダー（新規）
- `app/components/BottomTabs.tsx` — スマホ専用下部タブ（新規）
- `app/components/SideNav.tsx` — PC専用左サイドバー（新規）
- `app/components/AuthorModal.tsx` — 作者情報 Modal（新規）
- `app/routes/search.tsx` — 本棚検索ページ（新規）
- `app/routes.ts` — `search` ルート追加
- `app/root.tsx` — `AppShell` へ統合（top のみナビ非表示）

### 14-1. `AppShell.tsx`（レイアウト切替コンテナ）

- [ ] `root.tsx` に `AppShell` を導入し、top（`/`）のみナビ非表示にする条件分岐
- [ ] スマホ (`< lg`): `<Header>` 上局かつ `<BottomTabs>` 下部固定
- [ ] PC (`≥ lg`): `<SideNav>` 左固定 + メインコンテンツは `ml-60` 等でオフセット、`Header` / `BottomTabs` は非表示

### 14-2. スマホヘッダー（`Header.tsx`）

- [ ] 左端: my9books ロゴ（`/feed` にリンク）
- [ ] 右端: 作者情報アイコン（クリックで `AuthorModal` 表示）
- [ ] スマホのみ表示 (`lg:hidden`)
- [ ] `AuthorModal.tsx`: 製作者の簡単な説明・GitHub リンク等をモーダル表示

### 14-3. スマホ下部タブ（`BottomTabs.tsx`）

5タブ構成。スマホのみ表示 (`lg:hidden`)。

| タブ名     | アイコン目安 | 遷移先           | 備考                                    |
| ---------- | ------------ | ---------------- | --------------------------------------- |
| フィード   | 家           | `/feed`          |                                         |
| 検索       | 虫眼鏡       | `/search`        |                                         |
| 新規投稿   | ＋           | `/shelf/new`     | 未ログインは Clerk へ誘導               |
| マイページ | 人           | `/me`            | 未ログインは Clerk へ誘導               |
| 通知       | ベル         | `/notifications` | v3 実装まではアイコンのみ（タップ不可） |

- [ ] `BottomTabs.tsx` 実装

### 14-4. PC左サイドバー（`SideNav.tsx`）

PC (`≥ lg`)のみ表示 (`hidden lg:flex`)。スマホの下部タブ内容に加え、アカウント内容も包括する。

- [ ] 上部: my9books ロゴ
- [ ] ナビゲーションリンク（下部タブと同一構成）
  - フィード → `/feed`
  - 検索 → `/search`
  - 新規投稿 → `/shelf/new`
  - マイページ → `/me`
  - 通知 → `/notifications`（v3 まではアイコンのみ）
- [ ] 下部（ログイン済み時）:
  - アカウントアイコン + 表示名
  - 「登録情報の変更」リンク → Clerk UserProfile
  - 「ログアウト」ボタン
  - 作者情報アイコン → `AuthorModal`
- [ ] 下部（未ログイン時）: 「ログイン」ボタンのみ表示
- [ ] 現在のルートを強調表示（active スタイル）

### 14-5. /search ページ（本棚のみ）

- [ ] `app/routes/search.tsx` を新規作成
- [ ] テキスト入力で本棚名を検索（`shelves.name LIKE ?`）
- [ ] 検索ボックスの下に **例示タグチップ** を表示
  - クリックするとその文字列が検索ボックスに入力され即検索される
  - 固定テキストで表示（定数配列として管理）
  - 例: `私をかたちづくる本` `ライトノベル` `ミステリー` `2025年BEST` `おすすめ`
- [ ] 検索結果を本棚カード一覧で表示
- [ ] `routes.ts` に `route('search', 'routes/search.tsx')` を追加

---

## フェーズ 15: /feed タイムライン

### 関連ファイル

- `app/routes/feed.tsx` — タイムラインページ（新規）
- `app/routes.ts` — `feed` ルート追加
- `app/components/FeedShelfCard.tsx` — フルスクリーン本棚カード（新規）
- `.env` / `.env.example` — `FEED_GUEST_SWIPE_LIMIT=30`（新規追加）

### 15-1. DB・API

- [ ] `GET /api/shelves` にソートパラメータ追加（`sort=latest|bookmarks|random`）
  - `latest`: `shelves.created_at DESC`
  - `bookmarks`: `shelves.bookmarks_count DESC`
  - `random`: `ORDER BY RANDOM()`（おすすめ代替）
- [ ] ページネーション対応（`limit=20&offset=N`）

### 15-2. タイムライン UI

- [ ] `/feed` ルートを作成。初期ソートは `latest`
- [ ] フルスクリーン縦スクロール型レイアウト（各カードが viewport 1枚）
- [ ] ソート切替タブ（新着順 / ブックマーク数順 / おすすめ）を画面上部に配置
- [ ] 縦スワイプ（touch & マウスホイール）で前後の本棚に切替
- [ ] PC: ↑↓ 矢印キーで操作

### 15-3. GSAP アニメーション

- [ ] `gsap` をインストール（`bun add gsap`）
- [ ] 縦スワイプ時のカード切替: `gsap.to()` で Y軸スライドアニメーション
- [ ] 左右スワイプ時のブックマーク確定アニメーション: ハート or チェックマークが膨らんで消える

### 15-4. 左右スワイプでブックマーク

- [ ] 右スワイプ → ブックマーク追加 / 左スワイプ → ブックマーク解除（トグル）
- [ ] ログイン済み: `POST/DELETE /api/shelves/:id/bookmarks` を呼び出し
- [ ] 未ログイン: スワイプ上限未達の場合はスキップ（ブックマークしない）、上限後はログイン誘導

### 15-5. 未ログインユーザーのスワイプ制限

- [ ] `.env` に `FEED_GUEST_SWIPE_LIMIT=30` を追加（フロントで `import.meta.env` 参照）
- [ ] `sessionStorage` に `feedGuestSwipeCount` カウンターを保存
- [ ] 上限到達時: Clerkログイン画面へ誘導するモーダルを表示し、それ以上スワイプ不可
- [ ] Analytics に `feed_guest_limit_reached` イベントを送信（平均離脱スワイプ数の計測用）

---

## フェーズ 16: マイページ改善・top フッター

### 関連ファイル

- `app/routes/me.tsx` — Shelf 作成カード UI 変更・設定モーダル追加
- `app/routes/api.users.$userId.ts` — 名前変更 PATCH・アカウント削除（新規 or 既存拡張）
- `app/db/schema.ts` — `users.deleted_at` カラム追加
- `app/routes/home.tsx` — top フッター追加

### 16-1. /me の Shelf 作成 UI 変更

- [ ] 右上の「＋新しい本棚を作る」ボタンを削除
- [ ] Shelf一覧グリッドの **先頭（左端）** に同サイズの「新規作成カード」を配置
  - 中央に大きな ＋ アイコン
  - 未ログイン不可（そもそも /me は認証必須のため考慮不要）
  - クリックで `/shelf/new` へ遷移
- [ ] 一つもShelfがない場合は画面中央に「まだ本棚がありません。新しい本棚を作成しましょう！」のメッセージと新規作成カードを表示
  - メッセージは `COPY` から参照するように変更

### 16-2. マイページ設定

- [ ] `/me` に「設定」ボタンを追加（歯車アイコン等）
- [ ] 設定モーダルを表示
  - **名前変更**: `display_name` を入力して `PATCH /api/users/:userId` で更新
  - **アカウント削除**: 確認テキスト入力 → `DELETE /api/users/:userId`（ソフトデリート）
- [ ] `users` テーブルに `deleted_at TEXT` カラムを追加（`schema.ts` + Turso migration）
- [ ] 削除後は Clerk `signOut()` を実行しトップへリダイレクト
- [ ] `deleted_at IS NOT NULL` のユーザーは全ページで「退会済み」扱い（shelves は残すが表示名を「退会済みユーザー」に）

### 16-3. top フッター

- [ ] `home.tsx` のみにフッターを追加（他ページには表示しない）
- [ ] 表示内容（上から順）:
  1. `© 2025 my9books` — コピーライト
  2. 「本サービスはアフィリエイトプログラムを利用しています」— アフィリエイト表記
  3. GitHub リンク（外部リンク、新しいタブで開く）

---

## フェーズ 17: v3 - 通知機能

### 関連ファイル

- `app/db/schema.ts` - `notifications` テーブル（新規追加予定）
- `app/routes/api.notifications.ts` - 通知一覧取得
- `app/routes/api.notifications.$id.ts` - 既読マーク
- `app/routes/me.tsx` - 未読通知数バッジ・通知リストUI

### 17-0. DBスキーマ追加

- [ ] `notifications` テーブルを `schema.ts` に追加
  - `id` (UUID PK)
  - `userId` (FK→users) — 通知受取人
  - `actorId` (TEXT) — アクション実行者（将来：外部ユーザー名で表示）
  - `type` (TEXT) — `'shelf_liked'` / `'shelf_bookmarked'` 等
  - `shelfId` (TEXT, nullable) — 対象 Shelf
  - `isbn` (TEXT, nullable) — 対象本
  - `isRead` (INTEGER DEFAULT 0)
  - `createdAt` (TEXT)
- [ ] Turso に `CREATE TABLE notifications ...` を実行

### 17-1. いいね/ブックマーク時に通知を発生

- [ ] `api.shelves.$id.likes.ts` の POST 内で `notifications` に insert（shelf owner に対して）
- [ ] `api.shelves.$id.bookmarks.ts` の POST 内で `notifications` に insert
- [ ] 自分自身の shelf へのアクションは通知を発生しない

### 17-2. 通知 API

- [ ] `GET /api/notifications` — ログインユーザーの通知一覧（最奠20件、新しい順）
- [ ] `PATCH /api/notifications/:id` — 既読マーク

### 17-3. マイページに通知UI追加

- [ ] 未読通知数のバッジ表示（ページタイトルやナビ内）
- [ ] 通知リストUI（誤読未読区別・読み込み機能）

---

## 現在の進捗

| カテゴリ                        | 状況                                      |
| ------------------------------- | ----------------------------------------- |
| プロジェクトセットアップ        | ✅ 完了                                   |
| DBスキーマ（Drizzle + Turso）   | ✅ 完了                                   |
| Clerk 認証統合                  | ✅ 完了（ClerkProvider + rootAuthLoader） |
| Vercel Analytics 統合           | ✅ 完了                                   |
| ESLint + typecheck              | ✅ 完了                                   |
| 全ルートスタブ                  | ✅ 完了                                   |
| フェーズ 1: 認証基盤            | ✅ 完了                                   |
| フェーズ 2: 書籍検索 API        | ✅ 完了                                   |
| フェーズ 3: Shelf CRUD API      | ✅ 完了                                   |
| フェーズ 4: Shelf閲覧ページ     | ✅ 完了                                   |
| フェーズ 5: Shelf作成・編集     | ✅ 完了                                   |
| フェーズ 6: トップページ        | ✅ 完了                                   |
| フェーズ 7: マイページ等        | ✅ 完了                                   |
| フェーズ 8: SNS共有             | ✅ 完了                                   |
| フェーズ 9: UI文言・コピー管理  | ✅ 完了                                   |
| フェーズ 10: Analyticsイベント  | ✅ 完了                                   |
| フェーズ 11: OGP                | ✅ 完了                                   |
| フェーズ 12: v2 いいね等        | ✅ 完了                                   |
| フェーズ 12.6: 書影キャッシュ   | ✅ 完了                                   |
| フェーズ 13: SEO対策            | 🔲 未着手                                 |
| フェーズ 14: 共通レイアウト     | 🔲 未着手                                 |
| フェーズ 15: /feed タイムライン | 🔲 未着手                                 |
| フェーズ 16: マイページ改善     | 🔲 未着手                                 |
| フェーズ 17: v3 通知機能        | 🔲 未着手                                 |
